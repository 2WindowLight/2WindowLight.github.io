---
title: <h0>Module 8-6 Lesson 6 Virtual CPU and Memory Concepts</h0>
author: cotes   
categories: [cisco virtual cloud,2025-03-11-cisco]
tags: [Network, Cloud]






---

# Lesson 6: Virtual CPU and Memory Concepts



------

## 학습 목표:

* **가상화 환경에서 CPU와 메모리 개념을 설명할 수 있다.**
* **메모리 리소스 오버커밋(overcommitment)을 해결하기 위한 기법들을 이해하고 적용할 수 있다.**
* **메모리 사용을 개선하는 추가 기술들을 식별할 수 있다.**
* **VMware Virtual SMP가 어떻게 동작하는지 설명할 수 있다.**
* **VMkernel이 하이퍼스레딩(hyperthreading)을 어떻게 활용하는지 설명할 수 있다.**

------

------

## **Memory Virtualization Basics(메모리 가상화 기본 개념)**

![image-20250311100825183](/assets/cisco_post_img/2025-03-11-8-6//image-20250311100825183.png)

vSphere는 다음과 같은 계층의 메모리를 사용한다.

1. **게스트 OS 가상 메모리**
   * 애플리케이션이 게스트 운영 체제를 통해 접근하는 메모리

2. **게스트 OS 물리적 메모리**
   * VMkernel이 가상 머신(VM)에 제공하는 메모리
   * 가상머신에 할당했던 메모리

3. **호스트 머신 메모리**
   * VMkernel이 관리하는 실제 물리적 메모리 공간
   * 물리 메모리



------

**메모리 가상화 동작 방식**

* 가상 머신이 실행되면, VMkernel은 가상 머신을 위한 연속적인 메모리 주소 공간을 생성한다.
* 이 메모리 공간은 애플리케이션이 게스트 운영 체제를 통해 접근하는 가상 메모리 주소 공간과 동일한 속성을 가진다.
* VMkernel은 여러 개의 가상 머신을 동시에 실행하면서, 각 가상 머신의 메모리가 서로 접근되지 않도록 보호한다.
* 가상 머신 내부 애플리케이션의 관점에서 보면, VMkernel은 **추가적인 주소 변환 계층**을 제공하며, 게스트 물리적 주소를 호스트 물리적 주소로 매핑한다.



이러한 구조를 통해, vSphere는 다중 가상 머신을 효과적으로 실행하고 메모리 보호 기능을 강화할 수 있다.

------

------

**VM Memory Overcommitment(가상 머신 메모리 오버커밋)**

![image-20250311100812761](/assets/cisco_post_img/2025-03-11-8-6//image-20250311100812761.png)



위 그림은 여러 개의 VM이 실행되는 환경에서 물리적 메모리보다 많은 메모리가 할당된 경우를 보여줌.

​	•	각 VM이 12GB씩 할당받았으며, 총 4개의 VM이 존재함.

​	•	ESXi 호스트의 물리적 메모리가 32GB인 경우, 모든 VM이 풀 메모리를 사용하면 초과 할당이 발생함.

​	•	ESXi는 비활성 VM에서 메모리를 회수하고, 필요한 VM에 추가할당하는 방식으로 운영됨.

​	•	스왑 파일(.vswp)이 생성될 수 있으며, 메모리 과부하가 지속될 경우 성능 저하가 발생할 수 있음.

1. ------

   **메모리 오버커밋이란?**

​	•	모든 실행 중인 가상 머신(VM)의 총 메모리 할당량이 호스트의 물리적 메모리 크기를 초과하는 상태를 의미함.

​	•	VM은 항상 할당된 전체 메모리를 사용하지 않기 때문에 ESXi 호스트는 유휴 VM에서 메모리를 회수하여 더 많은 메모리가 필요한 VM에 할당함.

2. ------

   **메모리 오버커밋이 발생하면?**

​	•	일부 VM의 메모리가 .vswp 스왑 파일로 이동됨.

​	•	VM의 실행 오버헤드 메모리는 vmx-*.vswp 스왑 파일로 이동됨.

​	•	ESXi 호스트의 실제 물리적 메모리가 부족하면, 새로운 VM을 실행하지 못할 수도 있음.

3. ------

   **오버커밋 예제**

​	•	호스트의 물리적 메모리: 32GB

​	•	실행 중인 VM 3개: 각각 12GB의 메모리 할당

​	•	총 VM 메모리 할당량: 36GB

​	•	모든 VM이 유휴 상태이면 실제 사용되는 메모리는 32GB 이하이므로 문제가 없음.

​	•	하지만 모든 VM이 활성화되면 총 메모리 사용량이 32GB를 초과하여 **오버커밋 상태**가 됨.

4. ------

   **메모리 오버커밋의 영향**

​	•	일부 VM은 가벼운 작업을 수행하고, 일부는 무거운 작업을 수행하므로 ESXi는 메모리를 동적으로 관리함.

​	•	메모리 오버커밋이 지속되면 성능 저하가 발생할 수 있음.

​	•	새로운 VM을 실행하려 할 때 가용 메모리가 부족하면 실행이 실패할 수 있음.

5. ------

   **메모리 스왑 파일(.vswp) 사용**

​	•	ESXi 호스트가 물리적 메모리를 모두 사용하면, VM의 추가 메모리는 .vswp 스왑 파일로 이동됨.

​	•	ESXi는 vmx-*.vswp 파일을 사용하여 VM 실행에 필요한 오버헤드 메모리를 관리함.

​	•	메모리 스왑은 성능 저하를 유발할 수 있으므로, 가급적 물리적 메모리를 충분히 확보하는 것이 중요함.

6. ------

   **ESXi 메모리 관리 방식**

   ​	•	VM 메모리가 초과 할당되면, ESXi는 스왑 파일을 활용하여 가상 머신의 메모리를 디스크로 이동시킴.

   ​	•	초과 메모리는 **.vswp** 파일에 저장됨.

   ​	•	호스트는 **vmx-\*.vswp** 스왑 파일을 사용하여 VM 오버헤드 메모리를 관리함.
   
   ​	•	스왑은 성능 저하를 유발할 수 있으므로 가능하면 물리적 메모리 내에서 관리하는 것이 바람직함.

------

**결론**

메모리 초과 할당은 VM의 효율적인 리소스 사용을 가능하게 하지만, 관리되지 않을 경우 성능 저하 및 VM 실행 실패 등의 문제가 발생할 수 있음.

따라서 적절한 리소스 예약 및 메모리 최적화 기법을 활용하여 운영해야 함.

------

------

## **Memory Overcommit Techniques(메모리 초과 할당 기법)**



ESXi 호스트는 다양한 **메모리 초과 할당 기법**을 활용하여, 실제 물리적 메모리를 초과하여 메모리를 할당할 수 있도록 한다. 이를 통해 디스크로 메모리를 스왑하는 상황을 최소화하면서도 효율적인 메모리 관리가 가능하다.



------

**1. 메모리 초과 할당 기술 개요**

ESXi의 **VMkernel**은 동적으로 가상 머신(VM)이 요구하는 물리적 RAM을 줄이는 다양한 기술을 사용한다. 이러한 기술들은 **우선 순위에 따라** 적용된다.



------



**2. ESXi에서 사용하는 메모리 관리 기법**

| **기법**                                          | **설명**                                                     |
| ------------------------------------------------- | ------------------------------------------------------------ |
| **페이지 공유(Transparent Page Sharing)**         | 중복된 메모리 페이지를 단일 페이지로 저장하여 메모리를 절약하는 방식. vSphere 6.0 이후, VM 간 공유는 기본적으로 비활성화됨. |
| **벌루닝(Ballooning)**                            | VM의 메모리 사용량이 증가하면, VMware Tools의 벌룬 드라이버가 비활성 메모리를 해제하도록 강제하여 메모리를 확보하는 기법. |
| **메모리 압축(Memory Compression)**               | 호스트 수준 스왑이 필요해질 경우, 스왑 이전에 메모리를 압축하여 디스크 접근을 최소화함. 압축된 메모리는 디스크 스왑보다 성능 저하가 적음. |
| **호스트 스왑 캐시(Swap to Host Cache)**          | 로컬 플래시 스토리지를 활용하여 VM의 메모리를 캐싱함. 디스크로 스왑하는 경우보다 지연 시간이 짧아 성능 저하를 줄일 수 있음. |
| **호스트 레벨 스왑(Regular Host-Level Swapping)** | 메모리가 심각하게 부족할 경우, VM 메모리를 디스크로 스왑함. 성능 저하가 가장 큰 방식으로, 마지막 단계에서 실행됨. |





------



**3. ESXi의 메모리 관리 과정**

​	1.	**페이지 공유**: VM 간 중복 메모리 제거

​	2.	**벌루닝**: 사용되지 않는 메모리 회수

​	3.	**메모리 압축**: 스왑 전에 압축하여 저장

​	4.	**호스트 스왑 캐시 사용**: 로컬 SSD를 활용한 메모리 캐싱

​	5.	**디스크 스왑**: 가장 마지막 단계에서 수행되며 성능 저하가 큼



------



**4. 최적의 메모리 관리 방법**

​	•	ESXi의 메모리 압축과 벌루닝 기능을 적극 활용하여 스왑을 최소화해야 함.

​	•	**TPS(Transparent Page Sharing, 페이지 공유)**를 적절히 조정하여 중복 메모리를 제거할 수 있음.

​	•	물리적 메모리가 부족한 경우, **호스트 스왑 캐시**를 활성화하여 SSD를 활용하는 것이 성능 유지에 효과적임.

​	•	스왑이 발생하지 않도록 VM의 메모리 예약을 적절히 설정하는 것이 중요함.

------



**결론**

ESXi는 여러 개의 메모리 관리 기법을 통해 메모리 초과 할당을 효율적으로 관리한다. 특히, 페이지 공유, 벌루닝, 메모리 압축 등의 기법을 먼저 활용하여 스왑을 최소화하는 것이 성능 유지에 중요하다.



------

------

## **Configuring Multicore VMs(멀티코어 VM 구성)**

![image-20250311102751076](/assets/cisco_post_img/2025-03-11-8-6//image-20250311102751076.png)

ESXi 환경에서는 여러 개의 가상 CPU(vCPU)를 가지는 VM을 구성할 수 있다.

VM에 할당할 vCPU 개수는 **호스트의 물리적 아키텍처**, **게스트 운영체제**, **애플리케이션의 확장성 및 요구사항**, 그리고 **VM의 특정 사용 사례**에 따라 결정된다.



------



**1. 가상 CPU(vCPU) 및 물리적 CPU(LCPU) 개념**

| **용어**                  | **설명**                                                     |
| ------------------------- | ------------------------------------------------------------ |
| **vCPU(Virtual CPU)**     | VM에 할당된 가상 프로세서. ESXi의 CPU 스케줄러가 물리적 CPU에 매핑함. |
| **LCPU(Logical CPU)**     | 물리적 코어 내에서 실행 가능한 논리적 프로세서. 하이퍼스레딩이 활성화된 경우, 하나의 코어에 두 개 이상의 LCPU가 존재할 수 있음. |
| **소켓(Socket)**          | 단일 물리적 CPU 패키지로, 하나 이상의 코어를 포함할 수 있음. |
| **VMkernel CPU 스케줄러** | VM의 vCPU를 물리적 CPU에 동적으로 매핑하여 실행하는 역할.    |





------



**2. 멀티코어 VM 구성 요소**

​	•	**싱글 CPU 시스템**: 단일 vCPU를 할당하여 실행.

​	•	**듀얼 CPU 시스템**: 두 개의 vCPU를 할당하여 실행.

​	•	**쿼드 CPU 시스템**: 네 개 이상의 vCPU를 할당하여 실행.

​	•	**각 vCPU는 호스트의 LCPU(Logical CPU)에 매핑됨**.



------



**3. ESXi의 CPU 스케줄링 방식**

​	1.	**VM이 vCPU 요청** → VMkernel CPU 스케줄러가 요청을 수락

​	2.	**vCPU를 사용할 수 있는 LCPU에 매핑**

​	3.	**실행 후 스케줄링 변경이 필요하면 다시 매핑**

​	4.	**멀티코어 시스템에서는 여러 개의 vCPU를 동시에 스케줄링 가능**



------



**4. 멀티코어 VM 구성 시 고려 사항**

​	•	**vCPU 개수를 너무 많이 설정하면 과도한 오버헤드 발생 가능**

​	•	**애플리케이션 및 OS가 멀티코어를 최적화하여 활용하는지 확인 필요**

​	•	**CPU 오버커밋(Overcommit) 발생 시 성능 저하 가능**

​	•	**하이퍼스레딩이 활성화된 경우, LCPU 개수를 고려하여 적절한 vCPU 할당 필요**



------



**그림 설명**



위 그림은 **싱글, 듀얼, 쿼드 CPU 환경에서 vCPU가 LCPU에 매핑되는 방식**을 보여줌.

​	•	**싱글 CPU 시스템**: 하나의 vCPU가 하나의 LCPU에 매핑됨.

​	•	**듀얼 CPU 시스템**: 두 개의 vCPU가 각각 LCPU에 매핑됨.

​	•	**쿼드 CPU 시스템**: 네 개의 vCPU가 네 개의 LCPU에 각각 매핑됨.



이처럼 **vCPU는 가상화된 논리적 CPU(LCPU)에서 실행되며, VMkernel이 이를 효율적으로 스케줄링함**.



------



**결론**



멀티코어 VM을 구성할 때는 물리적 CPU 리소스, 애플리케이션 요구사항, CPU 오버커밋 가능성을 고려하여 적절한 vCPU 개수를 설정해야 한다. ESXi의 CPU 스케줄러는 가상 머신의 vCPU를 물리적 CPU에 동적으로 매핑하여 최적의 성능을 제공한다.



------

------

## **Hyperthreading(하이퍼스레딩) 개요**

![image-20250311102954885](/assets/cisco_post_img/2025-03-11-8-6//image-20250311102954885.png)

하이퍼스레딩(Hyperthreading)은 하나의 물리적 CPU 코어에서 **두 개의 스레드(명령어 집합)를 동시에 실행할 수 있도록 지원하는 기술**이다.



이 기능을 사용하면 **논리적 CPU(LCPU)의 개수가 증가**하여 vCPU의 스케줄링이 더욱 효율적으로 이루어진다.



------



**1. 하이퍼스레딩의 특징**

​	•	**한 개의 물리적 CPU 코어가 두 개의 스레드를 실행 가능**

​	•	**논리적 CPU 개수 증가 → vCPU 스케줄링 최적화**

​	•	**ESXi에서 기본적으로 활성화됨**



------



**2. 하이퍼스레딩 활성화 방법**

​	1.	**호스트 시스템이 하이퍼스레딩을 지원하는지 확인**

​	2.	**시스템 BIOS에서 하이퍼스레딩 활성화**

​	3.	**ESXi 호스트에서 하이퍼스레딩이 켜져 있는지 확인**



------



**3. 하이퍼스레딩이 적용된 환경의 장점**

​	•	**가상 머신의 vCPU를 보다 유연하게 스케줄링 가능**

​	•	**CPU 사용률 증가로 전체 성능 최적화**

​	•	**워크로드가 많은 환경에서 효율적으로 자원 활용**



------



**그림 설명**



위 그림은 **싱글 및 듀얼 CPU 환경에서 하이퍼스레딩이 적용된 구조**를 보여줌.

​	•	**싱글 CPU 시스템**: 하나의 vCPU가 LCPU(논리적 CPU)에 매핑됨.

​	•	**듀얼 CPU 시스템**: 두 개의 vCPU가 각각 논리적 CPU에 매핑됨.

​	•	**하이퍼스레딩이 활성화되면 하나의 LCPU가 두 개의 스레드를 실행할 수 있어 성능이 향상됨**.



------



**결론**



하이퍼스레딩을 활성화하면 하나의 물리적 코어에서 두 개의 스레드를 실행할 수 있어 **ESXi 호스트의 CPU 활용도가 향상**된다. 이를 통해 **가상 머신의 vCPU를 보다 효율적으로 스케줄링할 수 있으며, 고성능 환경에서 더욱 효과적인 리소스 활용이 가능하다**.

------

규칙을 완벽히 준수하여 다시 제공합니다.



------



## **CPU Load Balancing(CPU 부하 분산)**

CPU 부하 분산은 VMkernel이 프로세서 시간을 효율적으로 관리하여 시스템 내 프로세서 코어 전반에 걸쳐 부하를 균등하게 분배하는 방식이다. 이를 통해 가상 머신(VM)의 실행 성능을 최적화한다.



------



1. CPU 부하 분산 개요

​	•	VMkernel은 각 논리 프로세서를 독립적으로 활용하여 VM을 실행할 수 있도록 지원.

​	•	전통적인 대칭형 다중 처리(SMP) 시스템과 유사한 방식으로 작동.

​	•	CPU 부하는 2~40밀리초마다 VMkernel이 vCPU를 다른 논리 프로세서로 이동시켜 균형 유지.

2. CPU 부하 분산 방식

​	•	멀티 vCPU VM의 스케줄링

​	•	가능하면 서로 다른 코어에 vCPU를 할당하여 성능을 최적화.

​	•	그러나 필요할 경우 동일한 코어 내 논리 프로세서(하이퍼스레딩)에서 두 개의 vCPU를 실행할 수도 있음.

​	•	논리 프로세서(Hyper-Threading) 관리

​	•	논리 프로세서가 작업이 없을 경우, 중단 상태(Halted state)로 전환.

​	•	해당 논리 프로세서가 사용되지 않는 동안, 같은 코어의 다른 논리 프로세서가 코어의 모든 실행 리소스를 사용할 수 있음.

​	•	VMkernel 스케줄러는 이 중단 시간을 반영하여 VM이 전체 코어를 사용하는 경우 더 높은 비용을 부과.

3. ESXi의 자원 할당 규칙 준수

​	•	CPU 리소스가 적절하게 분배되도록 하여 VM 간의 성능 불균형을 방지.

​	•	VM 실행 환경에서 CPU 사용률이 최적화될 수 있도록 부하 분산을 자동 조정.



------



**그림 설명**



해당 이미지는 **CPU 부하 분산**의 개념을 시각적으로 나타낸 것이다.

​	•	**왼쪽**: 단일 CPU를 사용하는 VM이 논리 프로세서(LCPU)에 매핑됨.

​	•	**오른쪽**: 여러 개의 vCPU를 가진 VM이 두 개 이상의 LCPU에 분배됨.

​	•	**하단**: VMkernel이 논리 프로세서에 CPU 부하를 자동으로 조정하는 방식이 표현됨.



------



이제 모든 숫자 목록과 그림 설명 규칙이 올바르게 적용되었습니다. 다음에도 동일한 기준을 유지하겠습니다.