---
title: <h0>Module 8-4 Lesson 5 Creating Virtual Machine Snapshots</h0>
author: cotes   
categories: [cisco virtual cloud, 2025-03-10-cisco]
tags: [Network, Cloud, vShphere]

---

# Lesson 5: Creating Virtual Machine Snapshots



------

## **VM 스냅샷(VM Snapshots)**

![image-20250310162445586](/assets/cisco_post_img/8-5//image-20250310162445586.png)



VM 스냅샷은 가상 머신의 특정 상태를 저장하여 이후에 해당 시점으로 복원할 수 있도록 하는 기능이다. 이를 활용하면 패치 적용 또는 업그레이드 과정에서 문제가 발생했을 때 손쉽게 이전 상태로 되돌릴 수 있다. 하지만 스냅샷은 정식 백업 방식이 아니므로 장기적인 데이터 보호에는 적합하지 않다.



------



1. **VM 스냅샷의 주요 기능**
   * **특정 시점의 VM 상태 저장** → 패치 또는 업그레이드 전 상태를 기록하여 롤백 가능
   * **빠른 복원 기능 제공** → 오류 발생 시 신속하게 이전 상태로 되돌릴 수 있음
   * **반복적인 테스트 환경 구축 가능** → 동일한 상태를 유지하며 여러 차례 재실행 가능



------



2. **VM 스냅샷의 구조 및 관계**
   * **부모-자식 관계(Tree 구조)로 관리됨**
   * **각 스냅샷은 하나의 부모를 가지며, 다수의 자식을 가질 수 있음**
   * **최신 스냅샷은 자식이 없으며, 삭제 시 부모 스냅샷과 병합됨**
   * “Security Patch 1.0”이 부모 스냅샷이며, “Security Patch 1.2”는 해당 스냅샷의 자식이다.
   * 현재 “You are here” 표시가 있는 곳이 VM이 실행 중인 상태이며, 사용자는 필요 시 이전 스냅샷으로 롤백할 수 있다.
   * “Take Snapshot” 버튼을 클릭하면 새로운 스냅샷을 생성할 수 있으며, “Revert” 버튼을 통해 이전 스냅샷으로 복원 가능하다.



------



3. **VM 스냅샷 사용 시 고려 사항**
   * **장기 보관 금지** → 스냅샷을 장기간 유지하면 성능 저하 및 스토리지 사용량 증가 가능
   * **백업 대체 불가** → 스냅샷은 데이터 보호 수단이 아니므로 별도의 백업 솔루션 필요
   * **디스크 공간 관리 필요** → 스냅샷이 많아질수록 디스크 용량을 차지하므로 주기적인 정리가 필수



------



4. **VM 스냅샷 관리 방법**
   * **스냅샷 생성** → “Take Snapshot” 버튼 클릭
   * **스냅샷 복원** → “Revert” 버튼을 사용하여 특정 시점으로 복원 가능
   * **스냅샷 삭제** → “Delete” 또는 “Delete All” 버튼을 사용하여 불필요한 스냅샷 제거



------



5. **VM 스냅샷 활용 예시**
   * **운영체제(OS) 패치 또는 소프트웨어 업데이트 전 상태 저장**
   * **애플리케이션 테스트 환경 구축 및 반복적인 롤백 필요 시 활용**
   * **시스템 변경 후 문제가 발생할 경우 빠른 복구를 위해 사용**



------

**결론**

VM 스냅샷은 특정 시점의 VM 상태를 저장하여 복구 또는 테스트 목적으로 유용하게 활용할 수 있다. 하지만 백업 대체 용도로 사용하면 안 되며, 스냅샷 관리 정책을 통해 성능 저하를 방지하는 것이 중요하다.

------

------

## **스냅샷(Taking Snapshots)**

![image-20250310163013394](/assets/cisco_post_img/8-5//image-20250310163013394.png)

스냅샷은 VM이 실행 중이든, 종료 상태이든, 일시 중지 상태이든 언제든지 생성할 수 있다.

스냅샷을 생성하면 다음 항목이 캡처된다.

* **VM 설정(Configuration)**
* **VM 메모리 상태 (선택 사항, Memory State)**
* **가상 디스크 상태 (Virtual Disks)**



그러나 **독립형 가상 디스크(Independent Virtual Disks, 지속형 및 비지속형)는 포함되지 않는다.**



------



**스냅샷의 구성 요소**



스냅샷은 VM이 스냅샷을 생성한 시점의 전체 상태를 포함하며, 다음과 같은 세 가지 주요 상태를 기록한다.

1. **메모리 상태 (Memory State)**
   * VM의 메모리 내용을 포함한다.
   * VM이 실행 중이고 “Snapshot the virtual machine’s memory” 옵션이 선택된 경우에만 저장된다.

2. **설정 상태 (Settings State)**
   * VM의 모든 설정 정보가 포함된다.

3. **디스크 상태 (Disk State)**
   * VM의 모든 가상 디스크 상태를 저장한다.



------



**게스트 OS 정리(Quiescing) 옵션**

스냅샷을 생성할 때, 게스트 운영 체제의 파일 시스템을 정리(Quiesce)할 수도 있다.

* 해당 옵션은 **VM 메모리 상태를 캡처하지 않을 경우에만 선택 가능**하다.
* 게스트 운영 체제의 파일 시스템 정리는 VM 도구(VMware Tools)가 설치된 상태에서만 동작한다.



------



**그림 설명**

이미지는 **VM 스냅샷 생성 과정**을 시각적으로 표현한다.

* 스냅샷 생성 창에서 **Security Patch 1.0**이라는 이름으로 스냅샷을 생성하고 있다.
* VM의 실행 중인 애플리케이션과 운영 체제 상태가 저장된다.
* 변경된 데이터는 **delta.vmdk** 파일에 기록되며, 이후 스냅샷이 병합되거나 삭제될 때 기존 가상 디스크와 통합될 수 있다.
* 대기 중인 트랜잭션 데이터는 나중에 디스크에 커밋된다.

------

------

## **스냅샷 유형(Types of Snapshots)**

![image-20250310163233535](/assets/cisco_post_img/8-5//image-20250310163233535.png)

VM에서 스냅샷을 생성하면 **델타(Delta) 디스크** 또는 **자식(Child) 디스크**가 생성된다.

​	•	데이터 저장소(Datastore)에서는 델타 디스크가 **희소(Sparse) 디스크** 형태로 저장된다.

​	•	델타 디스크는 데이터 저장소 유형에 따라 다른 희소(Sparse) 형식을 사용한다.



------



1. **VMFSsparse 형식**

   * **적용 대상**
     * VMFS5 데이터스토어에서 **2TB 미만의 가상 디스크**에 사용됨.
     * VMFS 상단에 구현되는 **Redo 로그 기반의 기술**.

   *  **작동 방식**
     * VM 스냅샷이 생성되면 **VMFSsparse 레이어**가 I/O 작업을 처리함.
     * 스냅샷이 생성될 때, 초기 Redo 로그는 비어 있으며, VM이 새로운 데이터를 기록할 때 크기가 증가함.
     * VM의 기본 VMDK(Base VMDK)가 새롭게 생성된 **VMFSsparse VMDK**로 변경됨.



------



2. **SEsparse 형식**

   * **적용 대상**
     * **VMFS6 데이터스토어에서 모든 델타 디스크의 기본 형식.**
     * **VMFS5에서는 2TB 이상의 가상 디스크에 사용됨.**
     * VMFSsparse와 유사하지만 몇 가지 기능이 향상된 포맷.

   * **주요 기능**
     * 공간 절약(Space Efficiency)
     * 공간 회수(Space Reclamation) 지원
     * Guest OS의 삭제된 블록을 자동으로 정리(Unmapping)

   *  **작동 방식**
     * 게스트 OS가 데이터를 삭제하면, 해당 블록이 “삭제됨”으로 표시됨.
     * ESXi 하이퍼바이저의 SEsparse 레이어가 블록을 자동으로 정리(Unmapping).
     * **삭제된 데이터가 실제로 공간을 차지하지 않도록 관리**하여 스냅샷 크기를 최적화함.

------

------

**VM 스냅샷 파일(VM Snapshot Files)**

![image-20250310163454252](/assets/cisco_post_img/8-5//image-20250310163454252.png)

**그림 설명**

이 이미지는 vSphere 환경에서 VM 스냅샷과 관련된 다양한 파일을 보여준다. VM의 데이터스토어에는 여러 유형의 파일이 존재하며, 스냅샷이 생성될 때마다 새로운 델타 파일이 추가된다.

파일 목록에는 .vmsd, .vmsn, .vmem 등의 스냅샷 관련 파일들이 포함되어 있으며, VM의 현재 상태를 보존하는 역할을 한다.

------

VM 스냅샷을 생성하면 다양한 유형의 파일이 함께 생성된다. 각 파일은 VM의 특정 상태를 보존하는 역할을 하며, 스냅샷 삭제 시 일부 파일은 제거된다.



------



**1. VM 스냅샷을 구성하는 파일**

| **파일명**           | **역할**                                      |
| -------------------- | --------------------------------------------- |
| Snapshot#.vmsn       | **구성 상태(Configuration State)** 저장       |
| Snapshot#.vmem       | **메모리 상태(Memory State, 선택 사항)** 저장 |
| 00000#.vmdk          | **디스크 설명 파일(Disk Descriptor)**         |
| 00000#-delta.vmdk    | **VMFS5 델타 파일(VMFS5 Delta)**              |
| 00000#-sesparse.vmdk | **VMFS6 델타 파일(VMFS6 Delta)**              |
| .vmsd                | 모든 스냅샷의 **이름, 설명 및 관계** 저장     |





------



**2. 주요 스냅샷 파일 설명**

1. **스냅샷 델타 파일 (Delta File)**
   * 스냅샷 생성 이후 가상 디스크의 변경 사항을 저장하는 파일.
   * VM은 기존 -flat.vmdk 파일에 직접 쓰기를 하지 않고, 변경 사항을 -######-delta.vmdk 또는 -######-sesparse.vmdk에 기록.
   * 독립 디스크(Independent Disk)로 설정된 가상 디스크는 스냅샷에서 제외 가능.

2. **디스크 설명 파일 (Disk Descriptor File)**
   * 00000#.vmdk 파일은 작은 텍스트 파일로, 해당 스냅샷에 대한 메타데이터를 포함.
   * 가상 디스크에 대한 정보 저장.

3. **구성 상태 파일 (Configuration State File)**
   * .vmsn 파일은 VM의 **구성 상태**를 저장.
   * 활성 메모리 상태, 가상 하드웨어, 전원 상태 및 하드웨어 버전 등의 정보 포함.
   * VM이 스냅샷을 생성할 때마다 새로운 .vmsn 파일이 생성되며, 스냅샷 삭제 시 제거됨.

4. **메모리 상태 파일 (Memory State File)**
   * .vmem 파일은 스냅샷 생성 시 “메모리 포함” 옵션을 선택하면 생성됨.
   * VM의 전체 메모리 내용을 포함.
   * VM이 켜져 있는 상태에서 스냅샷을 생성한 경우 생성되며, 스냅샷 삭제 시 제거됨.

5. **스냅샷 목록 파일 (Snapshot List File)**
   * .vmsd 파일은 VM 생성 시 자동으로 생성되며, 해당 VM의 스냅샷 정보를 관리.
   * vSphere Client에서 스냅샷 목록을 생성하는 데 사용됨.



------



3. **스냅샷 파일 관리**
   * 독립 디스크(Independent Disk)로 설정된 가상 디스크는 스냅샷에서 제외 가능.
   * VM 하드웨어 버전에 따라 추가적인 파일이 생성될 수 있음.
   * 전원이 켜진 상태에서 스냅샷을 생성하면 .vmem 파일이 함께 생성됨.



**결론**

스냅샷 파일은 VM의 상태를 저장하여 롤백을 가능하게 하지만, 장기적인 백업 용도로 사용하기에는 적합하지 않다. 스냅샷을 적절히 관리하고 필요하지 않은 파일을 정리하는 것이 중요하다.

------

------

예시 상황

### VM Snapshot Files Example (1)

![image-20250310163900925](/assets/cisco_post_img/8-5//image-20250310163900925.png)

### VM Snapshot Files Example (2)

![image-20250310163917155](/assets/cisco_post_img/8-5//image-20250310163917155.png)

### VM Snapshot Files Example (3)

![image-20250310163942426](/assets/cisco_post_img/8-5//image-20250310163942426.png)

------

------

## **스냅샷 통합(Snapshot Consolidation)**



스냅샷 통합(Snapshot Consolidation)은 **Snapshot Manager**에서 스냅샷이 없는 것으로 표시되지만, 여전히 데이터스토어에 **델타 디스크(delta disk) 파일**이 남아 있는 경우 이를 기본 디스크(base disk)에 병합하는 방법이다.



------



1. **스냅샷 통합이 필요한 이유**
   * **스냅샷 관리자(Snapshot Manager)에서는 스냅샷이 삭제된 것으로 보이지만, 데이터스토어에 -delta.vmdk 또는 -sesparse.vmdk 파일이 남아 있음.**
   * **스냅샷 파일이 계속 확장되어 -flat.vmdk 파일 크기와 같아지거나 데이터스토어의 공간이 부족해질 위험이 있음.**
   * **스냅샷 설명자 파일(snapshot descriptor file)이 올바르게 적용되지 않아, 불필요한 스냅샷 파일이 유지될 가능성이 있음.**



------



2. **스냅샷 통합의 역할**
   * 스냅샷 통합은 데이터스토어에서 불필요한 **델타 디스크(delta disk) 파일**을 정리하는 역할을 한다.
   * VM에 등록된 스냅샷이 없는 경우에도 **델타 디스크 파일이 존재하면 스냅샷 통합을 수행하여 불필요한 파일을 제거함.**
   * 통합하지 않으면 **델타 디스크 파일이 계속 증가하여 VM의 데이터스토어 공간을 모두 소모할 수 있음.**
   * *델타 디스크 크기는 기본 디스크(base disk) 크기를 초과할 수 없음.**



------



3. **스냅샷 통합 프로세스**
   * **스냅샷 관리자에서 스냅샷이 없는 것으로 표시되지만, 데이터스토어에서 -delta.vmdk 또는 -sesparse.vmdk 파일이 발견됨.**
   * **스냅샷 통합을 수행하면, 델타 디스크의 변경 사항이 기본 디스크에 병합됨.**
   * **통합이 완료되면, 불필요한 스냅샷 파일이 제거됨.**

------

**결론**

스냅샷 통합은 VM 데이터스토어에서 불필요한 델타 디스크 파일을 정리하고, 데이터스토어 공간을 확보하는 중요한 과정이다.

스냅샷이 많아지면 VM 성능에 영향을 줄 수 있으므로, 정기적으로 스냅샷을 정리하고 필요할 때 **스냅샷 통합(Snapshot Consolidation)**을 수행하는 것이 권장된다.

------

------

## Consolidating Snapshots (스냅샷 병합)

![image-20250310165048765](/assets/cisco_post_img/8-5//image-20250310165048765.png)

------

------

