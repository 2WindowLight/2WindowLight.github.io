---
title: <h0>[Network] OSPF</h0>
author: cotes   
categories: [cisco virtual cloud]
tags: [Network]









---

## OSPF(Open Shortest Path First)

**OSPF(Open Shortest Path First)**는 **링크 상태 라우팅 프로토콜(Link-State Routing Protocol)**로, **라우터들이 네트워크 전체의 상태를 공유하면서 최적의 경로를 동적으로 계산하는 프로토콜.**

OSPF는 네트워크를 에어리어로 구분한다.



**OSPF 주요 특징**

​	•	**메트릭(Cost)**: 대역폭 기준 (대역폭이 높을수록 Cost가 낮아짐)

​	•	**빠른 컨버전스**: 네트워크 변경 시 빠르게 업데이트

​	•	**무한 루프 방지**: RIP과 다르게 Loop-Free 구조

​	•	**다중 경로 지원(ECMP)**: 같은 Cost의 경로가 여러 개 있을 경우 트래픽 분산

​	•	**멀티에어리어(Multi-Area OSPF) 지원**: 네트워크를 Area 단위로 구분하여 확장성 증가

![121213s](/Users/changhee/2WindowLight.github.io/_posts/images/2025-02-05-OSPF/121213s.png)

### R1

```bash
int lo 0
ip add 1.1.1.1 255.255.255.0
int e0/0
ip add 1.1.123.1 255.255.255.0
no sh
```



### R2

```bash
int lo 0
ip add 1.1.2.2 255.255.255.0
int e0/0
ip add 1.1.123.2 255.255.255.0
no sh
int e0/1
ip add 1.1.24.2 255.255.255.0
no sh
```



### R3

```bash
int lo 0
ip add 1.1.3.3 255.255.255.0
int e0/0
ip add 1.1.123.3 255.255.255.0
no sh
int e0/2
ip add 1.1.34.3 255.255.255.0
no sh
```



### R4

```bash
int lo 0
ip add 1.1.4.4 255.255.255.0
int e0/1
ip add 1.1.24.4 255.255.255.0
no sh
int e0/2
ip add 1.1.34.4 255.255.255.0
no sh
int e0/3
ip add 1.1.45.4 255.255.255.0
no sh
```



### R5

```bash
int lo 0
ip add 1.1.5.5 255.255.255.0
int e0/3
ip add 1.1.45.5 255.255.255.0
no sh
```

------

## 정리

네트워크를 보면, **R1 ↔ Switch1 ↔ R2, R3** 가 연결되고, **R2와 R3가 각각 R4와 연결**, 마지막으로 **R4 ↔ R5가 연결**되어 있다.

| 라우터 |                       인터페이스 정보                        |
| :----: | :----------------------------------------------------------: |
|   R1   |        e0/0 → 1.1.123.1 (Switch1을 통해 R2, R3 연결)         |
|   R2   |   e0/0 → 1.1.123.2 (R1과 연결), e0/1 → 1.1.24.2 (R4 연결)    |
|   R3   |   e0/0 → 1.1.123.3 (R1과 연결), e0/2 → 1.1.34.3 (R4 연결)    |
|   R4   | e0/1 → 1.1.24.4 (R2 연결), e0/2 → 1.1.34.4 (R3 연결), e0/3 → 1.1.45.4 (R5 연결) |
|   R5   |                  e0/3 → 1.1.45.5 (R4 연결)                   |

------

📌 **예제**

​	•	**출발지:** R1

​	•	**목적지:** R5

​	•	**경로:** R1 → R2 → R4 → R5 또는 R1 → R3 → R4 → R5

​	•	OSPF는 두 개의 경로를 비교해서 **최단 경로를 자동으로 선택**



쉽게 이해하는 예제

|     구분     |              실제               |
| :----------: | :-----------------------------: |
|   네트워크   |              도로               |
|    라우터    |           네비게이션            |
|     패킷     |             자동차              |
|     OSPF     | 최적의 경로를 계산하는 알고리즘 |
| SPF 알고리즘 |   네비게이션의 경로 탐색 기능   |

**OSPF가 하는 일**

​	•	네트워크 전체를 파악하고, **Dijkstra 알고리즘**을 사용하여 **최적 경로를 계산**

​	•	이 과정을 **SPF(Shortest Path First) 알고리즘**

------

 **OSPF 경로 선택 과정**

1. **Hello 패킷을 주고받아 이웃(Neighbor) 관계 형성**

2. **LSA(Link-State Advertisement) 정보를 서로 교환**

3. **SPF 알고리즘을 사용하여 최적 경로 계산**

4.  **라우팅 테이블에 경로 반영**

5.  **네트워크 변화 발생 시 다시 계산하여 최적 경로 업데이트**

------

주의점

* 만약 루프백 Id를 인터페이스에 IP 주소가 설정되어 있으면 그 중에서 가장 높은 것이 라우터 ID가 된다.
* 만약 루프백 인터페이스가 없으면, 가장 높은 IP 주소가 라우터 ID가 된다.
* OSPF 에어리어 번호는 32비트이며, 10진수를 사용해도 되고 주소 형식으로 사용해도 된다.
* 에어리어가 2개 이상일 때는 그 중 하나는 반드시 백본 에어리어가 되어야 하고, 백본 에어리어는 항상 에어리어 번호가 0 또는 0.0.0.0이 되어야 한다.

------

router 경로 설정

```bash
# router ospf process ID
```

MPLS VPN에서 OSPF 프로세서 id를 달리 설정한다.

```bash
# router-id 1.1.1.1 <- 식별자
```

네트워크 등록(네트워크 주소와 와일드 카드 지정)

```bash
# network 1.1.1.1 0.0.0.0 area 1 
```

​	•	1.1.1.1 → OSPF를 활성화할 IP 주소(인터페이스의 IP)

​	•	1.1.1.1 → OSPF를 활성화할 IP 주소(인터페이스의 IP)

​	•	area 1 → OSPF 영역(Area 1에 포함됨)

------

### 와일드 카드 연습

/24 subnet mask

-> 255.255.255.0 (11.... 0000 0000) - wilidcard mask = 0.0.0.255 (0000 ..... 1111 1111)

```bash
int lo 0
ip add 1.1.1.1 255.255.255.0

router ospf 1
network 1.1.1.0 0.0.0.255 area 1
```



------

OSPF 경로 설정

R1

```bash
conf t
router ospf 1
router-id 1.1.1.1
network 1.1.1.1 0.0.0.0 area 1
network 1.1.123.1 0.0.0.0 area 1
```

R2

```bash
conf t
router ospf 1
router-id 1.1.2.2
network 1.1.2.2 0.0.0.0 area 0
network 1.1.123.2 0.0.0.0 area 1
network 1.1.24.2 0.0.0.0 area 0
```

R3

```bash
conf t
router ospf 1
router-id 1.1.3.3
network 1.1.3.3 0.0.0.0 area 0
network 1.1.123.3 0.0.0.0 area 1
network 1.1.34.3 0.0.0.0 area 0
```

R4

```bash
conf t
router ospf 1
router-id 1.1.4.4
network 1.1.4.4 0.0.0.0 area 0
network 1.1.24.4 0.0.0.0 area 0
network 1.1.34.4 0.0.0.0 area 0
network 1.1.45.4 0.0.0.0 area 45
```

R5

```bash
conf t
router ospf 1
router-id 1.1.5.5
network 1.1.5.5 0.0.0.0 area 45
network 1.1.45.5 0.0.0.0 area 45
```

------

라우팅 테이블

OSPF를 통하여 전송받은 네트워크 앞에는 'O'라는 깋가 표시되어 있다.

이를 원래의 서브넷 마스크 값으로 광고하게 하려면 다음과 같이 인터페이스 설정 모드에서 ip ospf network pont-to-point 명령어 사용

```bash
R4(config-if)#do sh ip ro ospf
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override

Gateway of last resort is not set

      1.0.0.0/8 is variably subnetted, 13 subnets, 2 masks
O IA     1.1.1.0/24 [110/21] via 1.1.34.3, 00:20:58, Ethernet0/2
                    [110/21] via 1.1.24.2, 00:20:59, Ethernet0/1
O        1.1.2.0/24 [110/11] via 1.1.24.2, 00:21:18, Ethernet0/1
O        1.1.3.0/24 [110/11] via 1.1.34.3, 01:31:24, Ethernet0/2
O        1.1.5.0/24 [110/11] via 1.1.45.5, 01:10:29, Ethernet0/3
O IA     1.1.123.0/24 [110/20] via 1.1.34.3, 00:24:01, Ethernet0/2
                      [110/20] via 1.1.24.2, 00:21:18, Ethernet0/1

```



------

OSPF 패킷

| 패킷 타입 |      패킷 이름       |            역할            |
| :-------: | :------------------: | :------------------------: |
|     1     |        hello         |    네이버 구성 및 유지     |
|     2     | Database Description |   데이터베이스 내용 요약   |
|     3     |  Link State Request  | 데이터베이스 상세내용 요청 |
|     4     |  Link State Update   |   데이터베이스 업데이트    |
|     5     |    Link State Ack    |          ACK 전송          |



헬로(hello) 패킷

OSPF가 설정된 인터페이스를 통해 헬로 패킷을 송수신하여 인접 라우터와 네이버 관계를 형성한다.

헬로 패킷내에서는 라우터 ID, 에어리어 ID, 암호(설정된 경우), 서브넷 마스크, 헬로 주기, 스텁 에어리어 표시, 라우터 우선 순위, 데드 주기,DR, BDR, neighbor 리스트 정보가 들어가 있다.

![OSPF](/Users/changhee/2WindowLight.github.io/_posts/images/2025-02-05-OSPF/OSPF.png)

​	1.	**Frame 2: 94 bytes on wire (752 bits), 94 bytes captured (752 bits)**

​		•	캡처된 패킷의 크기가 **94 바이트(752 비트)**임을 나타냅니다.

​	2.	**Ethernet II, Src: aa:bb:cc:00:05:30, Dst: IPv4mcast_05 (01:00:5e:00:00:05)**

​		•	**출발지 MAC 주소:** aa:bb:cc:00:05:30

​		•	**목적지 MAC 주소:** 01:00:5e:00:00:05 (멀티캐스트 주소)

​	3.	**Internet Protocol Version 4, Src: 1.1.45.5, Dst: 224.0.0.5**

​		•	**출발지 IP:** 1.1.45.5 (OSPF 라우터)

​		•	**목적지 IP:** 224.0.0.5 (OSPF 라우터 그룹 멀티캐스트 주소)

​	4.	**0100 …. = Version: 4**

​		•	이 패킷은 **IPv4 패킷**임을 나타냅니다.

​	5.	**Differentiated Services Field: 0xc0 (DSCP: CS6, ECN: Not-ECT)**

​		•	DSCP 값이 **CS6**으로 설정되어 있으며, 이는 **네트워크 제어 트래픽**임을 의미합니다.

​	6.	**Total Length: 80**

​		•	패킷 전체 길이는 **80 바이트**입니다.

​	7.	**Protocol: OSPF IGP (89)**

​		•	이 패킷은 **OSPF 라우팅 프로토콜(89번 프로토콜 번호 사용)**에 속합니다.

​	8.	**Source Address: 1.1.45.5**

​		•	패킷을 보낸 라우터의 **IP 주소는 1.1.45.5**입니다.

​	9.	**Destination Address: 224.0.0.5**

​		•	목적지는 **224.0.0.5 멀티캐스트 주소**로, OSPF 라우터들이 공유하는 그룹 주소입니다.

​	10.	**Open Shortest Path First**

​		•	이 패킷은 **OSPF 패킷**이며, 라우터 간에 OSPF 정보를 교환하는 데 사용됩니다.

![OSPF2](/Users/changhee/2WindowLight.github.io/_posts/images/2025-02-05-OSPF/OSPF2.png)

### OSPF Hello 패킷 분석

**OSPF Header (OSPF 기본 정보)**

|           Version: 2           |                  설명                   |
| :----------------------------: | :-------------------------------------: |
| Message Type: Hello Packet (1) |        OSPF 버전 2 (IPv4용 OSPF)        |
|         패킷 길이 : 48         |    OSPF 패킷의 전체 길이 (48 바이트)    |
|  Source OSPF Router: 1.1.4.4   |     패킷을 보낸 라우터의 Router ID      |
|       Area IdL 0.0.0.45        |   이 OSPF 패킷이 속한 Area (Area 45)    |
|   CheckSum 0x8557 (correct)    | 패킷 데이터의 무결성 검사 (올바른 패킷) |
|         Auth type null         |            ospf 인증 사용 x             |
|      Auth Data: 000000000      |            인증 데이터 없음             |



헬로 패킷이 필요한 이유

✔ OSPF는 **링크 상태 라우팅 프로토콜**이므로, Neighbor 간 **연결 상태를 지속적으로 확인하는 과정이 필요**합니다.

✔ Hello 패킷은 이러한 **연결 상태를 점검하고, OSPF 네트워크를 안정적으로 유지**하는 역할을 합니다.

✔ OSPF가 Hello 패킷을 사용하는 이유는 다음과 같습니다.

------

## OSPF 동작 방식



### OSPF 네이버

**OSPF는 헬로 패킷을 이용하여 인접한 라우터와 먼저 네이버 관계를 구성한다.**

**OSPF는 물리적으로 직접 연결되는 라우터 중에서 헬로 패킷을 수신하고, 헬로 패킷에 포함된 네이버 리스트에 자신의 라우터 ID가 포함되어 있으면 그 라우터를 네이버로 간주**

**헬로 패킷에 기록된 에어리어 ID, 암호, 서브넷 마스크 길이, 헬로/데드 주기, 스텁 에어리어 표시가 서로 동일해야 한다.**

------

OSPF 네이버 확인하는 명령어

```bash
R2# show ip ospf neughbor
```

결과

```bash
Neighbor ID     Pri   State           Dead Time   Address         Interface
1.1.4.4           1   FULL/DR         00:00:39    1.1.24.4        Ethernet0/1
1.1.1.1           1   FULL/DR         00:00:34    1.1.123.1       Ethernet0/0
1.1.3.3           2   FULL/BDR        00:00:36    1.1.123.3       Ethernet0/0

```



OSPF 인터페이스 조회

```bash
R2# show ip ospf int e0/0
```

결과

```bash
Ethernet0/0 is up, line protocol is up 
  Internet Address 1.1.123.2/24, Area 1, Attached via Network Statement
  Process ID 1, Router ID 1.1.2.2, Network Type BROADCAST, Cost: 10
  Topology-MTID    Cost    Disabled    Shutdown      Topology Name
        0           10        no          no            Base
  Transmit Delay is 1 sec, State DROTHER, Priority 1
  Designated Router (ID) 1.1.1.1, Interface address 1.1.123.1
  Backup Designated router (ID) 1.1.3.3, Interface address 1.1.123.3
  Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5
    oob-resync timeout 40
    Hello due in 00:00:00
  Supports Link-local Signaling (LLS)
  Cisco NSF helper support enabled
  IETF NSF helper support enabled
  Index 1/2, flood queue length 0
  Next 0x0(0)/0x0(0)
  Last flood scan length is 6, maximum is 7
  Last flood scan time is 0 msec, maximum is 1 msec
  Neighbor Count is 2, Adjacent neighbor count is 2 
    Adjacent with neighbor 1.1.1.1  (Designated Router)
    Adjacent with neighbor 1.1.3.3  (Backup Designated Router)
  Suppress hello for 0 neighbor(s)

```



위 결과의 DR

```bash
  Designated Router (ID) 1.1.1.1, Interface address 1.1.123.1
```

라우터1이 DR이 되어 있는 상황

**IF**  만약에 라우터 1보다 라우터 3가 성능이 더 좋은경우 라우터 3이 DR이 되면 좋기 때문에 

아래의 명령어를 사용하여 우선순위 값의 범위를 바꾼다.



OSPF 우선순위 값의 범위

```bash
R3(config)# int e0/0
R3(config)# ip ospf priority 2
```

OSPF 우선순위가 모두 동일하면 기본 값이 1.

라우터 ID가 높은 것이 DR, 그 다음이 BDR - DR이 다운되면 BDR이 DR이 되고, DR BDR이 아닌 경우는 DROTHER 이라고 한다.



OSPF 프로세스를 리프레시 

```bash
R3# clear ip ospf process
```

우선순위를 변경하였더라도 라우팅을 재부팅 하거나 리프래시를 하지 않았을 경우에는 우선 순위 할당이 반영되지 않는다.



------

DR과 BDR

이더넷,NBMA 등의 멀티 엑세스 네트워크에 접속된

이더넷으로 돼 있으면 point to point 가 안됨



------

## OSPF 어드제이션시

OSPF 라우팅 정보를 주고 받는 네이버를 어드제이션트 네이버 라고 한다.

EOGRP 는 네이버가 되면 라우팅 정보를 주고 받으므로 모든 EIGRP 네이버는 서로 어드제이션트 네이버이다.

어드제이션트 네이버가 되는 경우

* DR 과 다른 라우터들
* BDR 과 다른 라우터들
* 포인트 투 포인트 네트워크로 연결된 두 라우터
* 포인트 투 멀티포인트 네트워크로 연결된 라우터들
* 가상 링크로 연결된 두 라우터

------

## 네이버 상태의 변화



**init 상태 - 네이버에게서 헬로 패킷을 받았으나 상대 라우터는 아직 나의 헬로 패킷을 수신하지 못한 상태**

**two-way 상태 - 네이버와 쌍방향 통신이 이루어진 상태 즉, DROTHER 이므로 같은 라우터끼리는 정보를 교환하지 않는다**

**예를 들어 5개의 라우터가 있고, R5 - Full DR | R4 - Full BDR 이라고 가정하면 R3,R2,R1 DROTHER 상태로 투 웨이 싱태가 된다.**

**엑스스타트 - 어드제이션트 네이버가 되는 첫 단계이다. 마스터와 슬레이브를 선출하는데 라우터 ID 가 높은 것이 마스터가 된다. 또 다음 단계에서 DDP 패킷 교환시 사용하는 DDP 패킷의 순서 번호를 결정**

로딩 상태

**풀 상태 - 어드제이션트 라우터들간에 라우팅 정보교환이 끝난 상태 즉, 어드제이션트 라우터들의 링크 상태 데이터베이스 내용이 모두 일치**

------

## **OSPF 메트릭 (cost )** 

경로 결정 기준으로 출발지부터 목적지까지의 각 인터페이스에서 기준 대역폭을 실제 대역폭으로 나눈 값의 합계

![image-20250206155722770](/Users/changhee/2WindowLight.github.io/_posts/images/2025-02-05-OSPF/image-20250206155722770.png)



**AD** - 라우팅 프로토콜 간에 우선순위를 매김



## 기준 대역폭 변경

```bash
router ospf 1
auto-cost reference-bandwidth 10000
```

## OSPF 인터페이스 코스트 변경

```bash
R4(config-if)#ip ospf cost 5
```

## 코스트 변경 확인 명령어

```bash
# do show ip ospf int e0/3
```

인터페이스에 세팅하는 것이 우선순위가 더 높음

------

###  **OSPF 경로 유형**

O > O IA > O E2

|          경로 유형          |                             설명                             |
| :-------------------------: | :----------------------------------------------------------: |
|     O (OSPF Intra-Area)     |             같은 Area 내부에서 학습된 OSPF 경로              |
|   O IA (OSPF Inter-Area)    |        다른 Area에서 온 OSPF 경로 (ABR을 통해 학습됨)        |
| O E2 (OSPF External Type 2) | OSPF 외부 경로 (EIGRP, RIP 등 다른 라우팅 프로토콜에서 온 경로) |

------

### 현재 라우터의 OSPF 설정을 확인하는 명령어

```
sh run | section router ospf
```

### OSPF 네트워크 변경 과정

```
router ospf 1
no network 1.1.2.2 0.0.0.0 area 0
network 1.1.2.2 0.0.0.0 area 1
```

**이 과정이 OSPF 경로 타입에 미치는 영향**

​	• **기존에 O로 표시되던 경로가 O IA로 바뀔 가능성이 있음.**

​	• **Area 0에 있던 경로가 Area 1로 이동하면서 Inter-Area(O IA)로 처리될 수 있음.**

​	• 기존의 **OSPF 라우팅 테이블이 변경될 가능성이 있음.**



------

## OSPF 에어리어



#### OSPF 에어리어의 규칙

* 모든 area는 백본 area에 연결해야함 
* 백본 area는 분리되면 안됨

summary

10.10.0000 0000.0/24

10.10.0000 0001.0/24

10.10.0000 0010.0/24

10.10.0000 0011.0/24

-----------------

10.10.0.0/22

불안정한 에어리어 줄임

summary 할려고

외부 네트워크를 제어하려고 에어리어를 나눈다.

### Stub 에어리어 - 





------

OSPF 종류

백본 라우터



내부 라우터



ABR 



ASBR(재분배 라우터)
